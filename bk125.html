<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Hall Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .seat.available {
            background-color: #4ade80; /* Brighter green */
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .seat.available:hover {
            transform: translateY(-2px);
            background-color: #22c55e;
        }
        .seat.booked {
            background-color: #f87171; /* Brighter red */
            cursor: pointer;
            box-shadow: 0 4px 6px -1-px rgba(0,0,0,0.1), 0 2px 4px -1-px rgba(0,0,0,0.06);
        }
        .seat.reserved {
            background-color: #fb923c; /* Brighter orange */
            cursor: pointer;
            box-shadow: 0 4px 6px -1-px rgba(0,0,0,0.1), 0 2px 4px -1-px rgba(0,0,0,0.06);
        }
        .seat.selected {
            background-color: #3b82f6; /* Blue for selection */
            transform: scale(1.05);
            animation: pulse 1s infinite;
            box-shadow: 0 10px 15px -3px rgba(59,130,246,0.3), 0 4px 6px -2px rgba(59,130,246,0.2);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
        }
        .seat.unavailable {
            background-color: #e2e8f0;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #e5e7eb;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-start justify-center min-h-screen p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="main-container" class="w-full max-w-7xl bg-white rounded-3xl shadow-2xl flex flex-col lg:flex-row p-6 md:p-12 transition-all duration-300 transform scale-100 opacity-100 lg:h-[90vh] lg:overflow-hidden">
        <div id="loading-screen" class="flex flex-col items-center justify-center p-8 text-center text-gray-500">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Initializing app and connecting to database...</p>
        </div>
    </div>
    
    <!-- Modal for Booking and Admin Actions -->
    <div id="booking-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-8 shadow-2xl w-full max-w-lg modal-content max-h-[95vh] overflow-y-auto">
            <h2 id="modal-title" class="text-3xl font-bold text-gray-800 mb-6 text-center">Manage Seat</h2>
            <form id="booking-form" class="space-y-6 hidden">
                <div>
                    <label for="book-user-id" class="block text-gray-700 font-semibold mb-2">Book for User ID</label>
                    <input type="text" id="book-user-id" name="book-user-id" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste user ID here" required>
                </div>
                <div>
                    <label for="name" class="block text-gray-700 font-semibold mb-2">Full Name</label>
                    <input type="text" id="name" name="name" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="mobile" class="block text-gray-700 font-semibold mb-2">Mobile Number (10 digits)</label>
                    <input type="tel" id="mobile" name="mobile" pattern="[0-9]{10}" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="gender" class="block text-gray-700 font-semibold mb-2">Gender</label>
                    <select id="gender" name="gender" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <!-- Start Date and Subscription Type -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-gray-700 font-semibold mb-2">Start Date</label>
                        <input type="date" id="start-date" name="start-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="subscription-type" class="block text-gray-700 font-semibold mb-2">Subscription Type</label>
                        <select id="subscription-type" name="subscription-type" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select duration</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="half-yearly">Half-Yearly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="end-date" class="block text-gray-700 font-semibold mb-2">End Date</label>
                    <input type="date" id="end-date" name="end-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <!-- ID Card Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="id-type" class="block text-gray-700 font-semibold mb-2">ID Card Type</label>
                        <select id="id-type" name="id-type" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select ID Type</option>
                            <option value="Aadhar Card">Aadhar Card</option>
                            <option value="PAN Card">PAN Card</option>
                            <option value="Voter ID">Voter ID</option>
                            <option value="Passport">Passport</option>
                        </select>
                    </div>
                    <div>
                        <label for="id-file" class="block text-gray-700 font-semibold mb-2">Upload ID Card</label>
                        <input type="file" id="id-file" name="id-file" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="submit" class="w-full text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 shadow-lg bg-blue-600 hover:bg-blue-700">Book Seat</button>
                    <button type="button" id="close-modal-btn" class="w-full text-gray-700 font-bold py-3 px-6 rounded-xl transition-all duration-200 bg-gray-200 hover:bg-gray-300">Close</button>
                </div>
            </form>
            <div id="action-buttons-container" class="space-y-4">
                <div id="action-buttons" class="space-y-4">
                    <!-- Manager action buttons will be rendered here -->
                </div>
                <button type="button" id="close-modal-btn-2" class="w-full text-gray-700 font-bold py-3 px-6 rounded-xl transition-all duration-200 bg-gray-200 hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom confirmation modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-8 shadow-2xl w-full max-w-sm modal-content text-center">
            <i class="fa-solid fa-triangle-exclamation text-yellow-500 text-5xl mb-4"></i>
            <p id="confirmation-text" class="text-lg text-gray-700 mb-6">Are you sure you want to delete this booking?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes" class="bg-red-500 text-white font-bold py-2 px-6 rounded-xl transition-colors hover:bg-red-600">Yes, Delete</button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-xl transition-colors hover:bg-gray-400">No, Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, Timestamp, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('debug');

        // These variables are provided by the canvas environment.
        // For local development, they will be undefined.
        // Import the functions you need from the SDKs you need

// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDiqsIPMB_6R6NUQL1mE6Yeexd4saUbnaw",
  authDomain: "study-hall-management-app.firebaseapp.com",
  projectId: "study-hall-management-app",
  storageBucket: "study-hall-management-app.firebasestorage.app",
  messagingSenderId: "858408884589",
  appId: "1:858408884589:web:8ee0bfeb694415cea02264"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        let userId;
        let selectedSeat = null;
        let seatData = [];
        let bookedSeatsList = [];
        let currentRoom = 'Room 1';
        let isManager = true; // Hardcoded to true as per request
        let onSnapshotUnsubscribe = null;

        const mainContainer = document.getElementById('main-container');
        const bookingModal = document.getElementById('booking-modal');
        const bookingForm = document.getElementById('booking-form');
        const actionButtonsContainer = document.getElementById('action-buttons-container');
        const bookUserIdInput = document.getElementById('book-user-id');
        const modalTitle = document.getElementById('modal-title');
        const actionButtonsDiv = document.getElementById('action-buttons');
        const closeBtn2 = document.getElementById('close-modal-btn-2');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');

        const startDateInput = document.getElementById('start-date');
        const subscriptionTypeSelect = document.getElementById('subscription-type');
        const endDateInput = document.getElementById('end-date');
        
        closeBtn2.addEventListener('click', () => bookingModal.classList.add('hidden'));
        confirmNoBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));

        // Start initialization immediately
        (async () => {
            try {
                // Correct authentication logic: use custom token if available, otherwise sign in anonymously
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                
                // Since the app is for managers only, we directly initialize the UI
                initializeManagerUI();
                listenForBookings();
            } catch (error) {
                console.  error("Firebase auth error:", error);
                // Display access denied if authentication fails for any reason
                mainContainer.innerHTML = `<div class="flex flex-col items-center justify-center p-8 text-center text-red-500 min-h-screen">
                    <i class="fa-solid fa-lock text-6xl mb-4"></i>
                    <h1 class="text-4xl font-extrabold mb-2">Access Denied</h1>
                    <p class="text-lg font-medium">You do not have permission to access this page.</p>
                    <p class="mt-4 text-sm text-gray-500 break-all">User ID: <span class="font-mono break-all text-gray-700">${userId}</span></p>
                </div>`;
            }
        })();

        function initializeManagerUI() {
            mainContainer.innerHTML = `
                <div class="w-full flex flex-col p-4 md:p-8">
                    <div class="flex flex-col items-center mb-8">
                        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">Study Hall Admin Dashboard</h1>
                        <p class="text-gray-500 font-medium">Manage seats and view bookings.</p>
                        <div class="flex flex-wrap space-x-2 mt-4 rounded-full bg-gray-200 p-1">
                            <button id="room-1-btn" class="px-6 py-2 rounded-full text-white font-semibold transition-colors duration-200 bg-blue-500 hover:bg-blue-600">Room 1</button>
                            <button id="room-2-btn" class="px-6 py-2 rounded-full text-gray-700 font-semibold transition-colors duration-200 bg-gray-300 hover:bg-gray-400">Room 2</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center gap-4 mb-8 text-sm font-semibold">
                        <div class="flex items-center space-x-2 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-200">
                            <span class="w-4 h-4 rounded-full bg-green-400"></span>
                            <span>Available</span>
                        </div>
                        <div class="flex items-center space-x-2 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-200">
                            <span class="w-4 h-4 rounded-full bg-red-400"></span>
                            <span>Booked</span>
                        </div>
                        <div class="flex items-center space-x-2 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-200">
                            <span class="w-4 h-4 rounded-full bg-orange-400"></span>
                            <span>Reserved</span>
                        </div>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-3 text-center text-lg font-bold text-white mb-6 shadow-lg">Study Hall Entrance</div>
                    <div id="seat-map" class="grid gap-2 p-4 md:p-8 bg-gray-200 rounded-2xl w-full max-w-lg mx-auto shadow-inner">
                        <!-- Seats will be rendered here -->
                    </div>
                    <div id="admin-details-container" class="mt-8">
                        <div class="bg-gray-100 rounded-xl p-6 shadow-md border border-gray-200">
                            <h2 class="text-2xl font-bold text-gray-700 mb-4">Admin Dashboard</h2>
                            <div class="relative mb-4">
                                <input type="text" id="user-search" placeholder="Search by name or seat ID..." class="w-full p-2 pl-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div id="booked-users-list" class="space-y-4">
                                <!-- Booked users will be rendered here -->
                            </div>
                        </div>
                        <div class="bg-gray-100 rounded-xl p-6 shadow-md border border-gray-200 mt-8">
                            <h3 class="text-xl font-bold text-gray-600 mb-2">Expiring Bookings</h3>
                            <div id="expiring-reminders-list" class="space-y-4">
                                <!-- Reminders for expiring subscriptions will be rendered here -->
                            </div>
                        </div>
                    </div>
                    <div id="error-message" class="mt-4 text-sm text-red-600 font-medium"></div>
                    <p class="mt-4 text-sm text-gray-500 break-all">User ID: <span class="font-mono break-all text-gray-700" id="user-id-display">${userId}</span></p>
                </div>
            `;
            document.getElementById('room-1-btn').addEventListener('click', () => switchRoom('Room 1'));
            document.getElementById('room-2-btn').addEventListener('click', () => switchRoom('Room 2'));
            document.getElementById('user-search').addEventListener('input', (e) => filterBookedUsers(e.target.value));
            
            updateRoomButtons();
            
            bookingForm.addEventListener('submit', handleModalSubmit);
            document.getElementById('close-modal-btn').addEventListener('click', () => bookingModal.classList.add('hidden'));

            startDateInput.addEventListener('change', updateEndDate);
            subscriptionTypeSelect.addEventListener('change', updateEndDate);
        }

        function getSeatsCollectionPath(room) {
            // Firestore collection path for public data
            return `artifacts/${__app_id}/public/data/${room}`;
        }

        function switchRoom(room) {
            currentRoom = room;
            updateRoomButtons();
            listenForBookings();
            selectedSeat = null;
        }

        function updateRoomButtons() {
            const room1Btn = document.getElementById('room-1-btn');
            const room2Btn = document.getElementById('room-2-btn');
            if (!room1Btn || !room2Btn) return;
            if (currentRoom === 'Room 1') {
                room1Btn.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-700');
                room1Btn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
                room2Btn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
                room2Btn.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-700');
            } else {
                room2Btn.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-700');
                room2Btn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
                room1Btn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
                room1Btn.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-700');
            }
        }

        function updateEndDate() {
            const startDateStr = startDateInput.value;
            const subscriptionType = subscriptionTypeSelect.value;
            
            if (!startDateStr || !subscriptionType) {
                endDateInput.value = '';
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(startDate);
            
            switch (subscriptionType) {
                case 'weekly':
                    endDate.setDate(startDate.getDate() + 7);
                    break;
                case 'monthly':
                    endDate.setMonth(startDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    endDate.setMonth(startDate.getMonth() + 3);
                    break;
                case 'half-yearly':
                    endDate.setMonth(startDate.getMonth() + 6);
                    break;
                case 'yearly':
                    endDate.setFullYear(startDate.getFullYear() + 1);
                    break;
            }

            const formattedDate = endDate.toISOString().split('T')[0];
            endDateInput.value = formattedDate;
        }
        
        function renderSeats() {
            const seatMap = document.getElementById('seat-map');
            if (!seatMap) return;
            
            seatMap.innerHTML = '';
            
            let seatRows = [];
            let numSeats = 0;
            if (currentRoom === 'Room 1') {
                seatRows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                numSeats = 80;
            } else {
                seatRows = ['A', 'B', 'C', 'D'];
                numSeats = 40;
            }
            seatMap.style.gridTemplateColumns = `repeat(10, minmax(0, 1fr))`;

            for (let i = 0; i < numSeats; i++) {
                const row = seatRows[Math.floor(i / 10)];
                const col = (i % 10) + 1;
                const seatId = `${row}${col}`;

                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat w-7 h-7 md:w-8 md:h-8 rounded-lg flex items-center justify-center text-gray-800 text-xs font-bold shadow-md cursor-pointer';
                seatDiv.textContent = seatId;
                seatDiv.setAttribute('data-seat-id', seatId);

                const seat = seatData.find(s => s.id === seatId);
                const isBooked = seat && seat.isBooked;
                const isReserved = seat && seat.isReserved;
                
                if (isBooked) {
                    seatDiv.classList.add('booked');
                } else if (isReserved) {
                    seatDiv.classList.add('reserved');
                } else {
                    seatDiv.classList.add('available');
                }

                seatDiv.addEventListener('click', () => handleManagerSeatSelection(seatId));
                seatMap.appendChild(seatDiv);
            }
        }

        function handleManagerSeatSelection(seatId) {
            selectedSeat = seatId;
            
            const seat = seatData.find(s => s.id === seatId);

            modalTitle.textContent = `Seat ${seatId} (${seat?.isBooked ? 'Booked' : seat?.isReserved ? 'Reserved' : 'Available'})`;
            actionButtonsDiv.innerHTML = '';
            
            const unbookBtn = createButton('Unbook Seat', 'bg-red-500 hover:bg-red-600', () => handleUnbook(seatId));
            const bookBtn = createButton('Book for User', 'bg-blue-500 hover:bg-blue-600', () => showBookingForm(seatId));
            const reserveBtn = createButton('Reserve Seat', 'bg-orange-500 hover:bg-orange-600', () => handleReserve(seatId));
            const unreserveBtn = createButton('Unreserve Seat', 'bg-gray-500 hover:bg-gray-600', () => handleUnreserve(seatId));
            
            bookingForm.classList.add('hidden');
            actionButtonsContainer.classList.remove('hidden');

            if (seat && seat.isBooked) {
                actionButtonsDiv.appendChild(unbookBtn);
            } else if (seat && seat.isReserved) {
                actionButtonsDiv.appendChild(unreserveBtn);
            } else {
                actionButtonsDiv.appendChild(bookBtn);
                actionButtonsDiv.appendChild(reserveBtn);
            }

            bookingModal.classList.remove('hidden');
        }
        
        function showBookingForm(seatId) {
            modalTitle.textContent = `Book Seat ${seatId} in ${currentRoom}`;
            bookingForm.reset();
            bookingForm.classList.remove('hidden');
            actionButtonsContainer.classList.add('hidden');
        }

        async function handleModalSubmit(event) {
            event.preventDefault();
            
            const name = document.getElementById('name').value;
            const mobile = document.getElementById('mobile').value;
            const gender = document.getElementById('gender').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const idType = document.getElementById('id-type').value;
            const idFile = document.getElementById('id-file').files[0];
            const idFileName = idFile ? idFile.name : null;
            const targetUserId = bookUserIdInput.value;

            if (!name || !mobile || !gender || !startDate || !endDate || !idType || !idFile || !targetUserId) {
                showError("Please fill out all fields.");
                return;
            }

            const bookingData = {
                name,
                mobile,
                gender,
                startDate,
                endDate,
                idType,
                idFileName,
                verified: true,
            };
            
            await handleBook(selectedSeat, bookingData, targetUserId);
            bookingModal.classList.add('hidden');
        }
        
        function isExpiringTomorrow(endDateStr) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const endDate = new Date(endDateStr);

            return (endDate.getFullYear() === tomorrow.getFullYear() && 
                    endDate.getMonth() === tomorrow.getMonth() && 
                    endDate.getDate() === tomorrow.getDate());
        }

        function updateBookedUsersList(list) {
            const bookedUsersListDiv = document.getElementById('booked-users-list');
            if (!bookedUsersListDiv) return;

            bookedUsersListDiv.innerHTML = '';
            
            if (list.length === 0) {
                bookedUsersListDiv.innerHTML = '<p class="text-center text-gray-500 py-4">No seats are currently booked.</p>';
                return;
            }

            list.forEach(seat => {
                const seatInfo = document.createElement('div');
                seatInfo.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-200';
                
                const userName = seat.name || 'Unknown User';
                const verificationIcon = seat.verified ? 
                    '<i class="fa-solid fa-circle-check text-green-500 ml-2" title="Verified"></i>' :
                    '<i class="fa-solid fa-circle-exclamation text-yellow-500 ml-2" title="Verification Pending"></i>';
                
                seatInfo.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="text-lg font-semibold text-gray-800">Seat ${seat.id}</h3>
                        <p class="text-sm font-medium text-gray-500">Booked</p>
                    </div>
                    <p class="text-md text-gray-600 font-medium">${userName} ${verificationIcon}</p>
                    <p class="text-sm text-gray-500 mt-1">Dates: ${seat.startDate} to ${seat.endDate}</p>
                    <p class="text-sm text-gray-500 break-all mt-1">User ID: <span class="font-mono break-all text-gray-700">${seat.bookedBy}</span></p>
                    <div class="flex space-x-2 mt-4">
                        <button class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-xl hover:bg-red-600 transition-colors delete-btn" data-seat-id="${seat.id}">Delete</button>
                    </div>
                `;
                bookedUsersListDiv.appendChild(seatInfo);
            });
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const seatId = e.target.dataset.seatId;
                    showConfirmationModal(seatId);
                });
            });
        }

        function updateExpiringReminders(list) {
            const expiringListDiv = document.getElementById('expiring-reminders-list');
            if (!expiringListDiv) return;

            expiringListDiv.innerHTML = '';
            
            const expiringSeats = list.filter(seat => seat.isBooked && isExpiringTomorrow(seat.endDate));
            
            if (expiringSeats.length === 0) {
                expiringListDiv.innerHTML = '<p class="text-gray-500">No subscriptions are expiring tomorrow.</p>';
                return;
            }

            expiringSeats.forEach(seat => {
                const reminderDiv = document.createElement('div');
                reminderDiv.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-sm';
                reminderDiv.innerHTML = `
                    <p class="font-semibold text-lg">Seat ${seat.id}</p>
                    <p>Booked by: <span class="font-medium">${seat.name}</span></p>
                    <p>Ends: <span class="font-medium">${seat.endDate}</span></p>
                `;
                expiringListDiv.appendChild(reminderDiv);
            });
        }

        function filterBookedUsers(searchTerm) {
            const lowerCaseTerm = searchTerm.toLowerCase();
            const filteredList = bookedSeatsList.filter(seat => 
                (seat.name && seat.name.toLowerCase().includes(lowerCaseTerm)) ||
                (seat.id && seat.id.toLowerCase().includes(lowerCaseTerm))
            );
            updateBookedUsersList(filteredList);
        }

        function createButton(text, colorClasses, onClick) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = `w-full text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 shadow-lg ${colorClasses}`;
            btn.addEventListener('click', onClick);
            return btn;
        }

        async function handleBook(seatId, bookingData, targetUserId) {
            const publicCollectionPath = getSeatsCollectionPath(currentRoom);
            const seatRef = doc(db, publicCollectionPath, seatId);
            try {
                const currentSeat = seatData.find(s => s.id === seatId);
                if (currentSeat && (currentSeat.isBooked || currentSeat.isReserved)) {
                    showError("This seat is no longer available. Please select another.");
                    return;
                }

                await setDoc(seatRef, {
                    id: seatId,
                    isBooked: true,
                    isReserved: false,
                    bookedBy: targetUserId,
                    bookedAt: Timestamp.now(),
                    ...bookingData
                });
                showSuccess("Seat booked successfully!");
            } catch (e) {
                console.error("Error booking seat: ", e);
                showError("Failed to book seat. Please try again.");
            }
        }

        function showConfirmationModal(seatId) {
            document.getElementById('confirmation-text').textContent = `Are you sure you want to delete the booking for Seat ${seatId}?`;
            confirmationModal.classList.remove('hidden');
            confirmYesBtn.onclick = async () => {
                confirmationModal.classList.add('hidden');
                await handleUnbook(seatId);
            };
        }

        async function handleUnbook(seatId) {
            const publicCollectionPath = getSeatsCollectionPath(currentRoom);
            const seatRef = doc(db, publicCollectionPath, seatId);
            try {
                const currentSeat = seatData.find(s => s.id === seatId);
                if (!currentSeat || !currentSeat.isBooked) {
                    showError("This seat is not currently booked.");
                    return;
                }

                await deleteDoc(seatRef);
                showSuccess("Booking deleted successfully!");
            } catch (e) {
                console.error("Error unbooking seat: ", e);
                showError("Failed to delete booking. Please try again.");
            }
            bookingModal.classList.add('hidden');
        }

        async function handleReserve(seatId) {
            const publicCollectionPath = getSeatsCollectionPath(currentRoom);
            const seatRef = doc(db, publicCollectionPath, seatId);
            try {
                const currentSeat = seatData.find(s => s.id === seatId);
                if (currentSeat && (currentSeat.isBooked || currentSeat.isReserved)) {
                    showError("This seat is not available to be reserved.");
                    return;
                }

                await setDoc(seatRef, {
                    id: seatId,
                    isBooked: false,
                    isReserved: true,
                    reservedAt: Timestamp.now(),
                });
                showSuccess("Seat reserved successfully!");
            } catch (e) {
                console.error("Error reserving seat: ", e);
                showError("Failed to reserve seat. Please try again.");
            }
            bookingModal.classList.add('hidden');
        }

        async function handleUnreserve(seatId) {
            const publicCollectionPath = getSeatsCollectionPath(currentRoom);
            const seatRef = doc(db, publicCollectionPath, seatId);
            try {
                const currentSeat = seatData.find(s => s.id === seatId);
                if (!currentSeat || !currentSeat.isReserved) {
                    showError("This seat is not currently reserved.");
                    return;
                }

                await deleteDoc(seatRef);
                showSuccess("Reservation removed successfully!");
            } catch (e) {
                console.error("Error unreserving seat: ", e);
                showError("Failed to remove reservation. Please try again.");
            }
            bookingModal.classList.add('hidden');
        }

        let timeoutId = null;
        function showError(message) {
            const errorMessageDiv = document.getElementById('error-message');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = message;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    errorMessageDiv.textContent = '';
                }, 5000);
            }
        }

        function showSuccess(message) {
            const errorMessageDiv = document.getElementById('error-message');
            if (errorMessageDiv) {
                errorMessageDiv.classList.remove('text-red-600');
                errorMessageDiv.classList.add('text-green-600');
                errorMessageDiv.textContent = message;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    errorMessageDiv.textContent = '';
                    errorMessageDiv.classList.remove('text-green-600');
                    errorMessageDiv.classList.add('text-red-600');
                }, 5000);
            }
        }

        function listenForBookings() {
            if (onSnapshotUnsubscribe) {
                onSnapshotUnsubscribe(); // Detach previous listener
            }

            const publicCollectionRef = collection(db, getSeatsCollectionPath(currentRoom));
            onSnapshotUnsubscribe = onSnapshot(publicCollectionRef, (querySnapshot) => {
                seatData = querySnapshot.docs.map(doc => doc.data());
                bookedSeatsList = seatData.filter(seat => seat.isBooked);
                renderSeats();
                updateBookedUsersList(bookedSeatsList);
                updateExpiringReminders(bookedSeatsList);
            }, (error) => {
                console.error("Error listening to Firestore changes:", error);
                showError("Failed to get real-time data. Please refresh the page.");
            });
        }
    </script>
</body>
</html>
