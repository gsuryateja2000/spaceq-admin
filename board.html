<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyHalls Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#080c14;--surface:#0d1421;--card:#111927;--border:#1e2d42;
    --accent:#00d4ff;--accent2:#ff6b35;--green:#10b981;--red:#ef4444;
    --yellow:#f59e0b;--purple:#7c3aed;--text:#e2e8f0;--muted:#64748b;
    --fh:'Syne',sans-serif;--fm:'Space Mono',monospace;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--fh);min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.025) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}

  /* CONNECT SCREEN */
  #connectScreen{
    position:fixed;inset:0;z-index:100;
    display:flex;align-items:center;justify-content:center;
    background:var(--bg);
  }
  .connect-box{
    background:var(--card);border:1px solid var(--border);border-radius:20px;
    padding:40px;max-width:560px;width:90%;text-align:center;
    box-shadow:0 40px 80px rgba(0,0,0,0.6);
  }
  .connect-box h2{font-size:1.6rem;font-weight:800;margin-bottom:6px;}
  .connect-box p{color:var(--muted);font-size:0.82rem;line-height:1.6;margin-bottom:28px;}
  .step-row{display:flex;flex-direction:column;gap:12px;margin-bottom:24px;text-align:left;}
  .step{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;border-radius:10px;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.15);}
  .step-num{width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;font-size:0.7rem;font-weight:800;display:grid;place-items:center;flex-shrink:0;margin-top:1px;}
  .step-text{font-size:0.75rem;color:var(--text);line-height:1.5;}
  .step-text strong{color:var(--accent);}
  .step-text code{background:rgba(0,212,255,0.1);padding:1px 6px;border-radius:4px;font-family:var(--fm);font-size:0.68rem;color:var(--accent);}

  .input-group{position:relative;margin-bottom:14px;}
  .input-group label{display:block;font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:left;}
  .input-group input{
    width:100%;background:var(--surface);border:1px solid var(--border);
    color:var(--text);padding:12px 16px;border-radius:10px;
    font-family:var(--fm);font-size:0.75rem;outline:none;
    transition:border-color 0.2s;
  }
  .input-group input:focus{border-color:var(--accent);}
  .input-group input::placeholder{color:var(--muted);}
  .extracted-id{
    font-size:0.7rem;font-family:var(--fm);
    padding:6px 12px;border-radius:6px;margin-bottom:12px;
    display:none;text-align:left;
  }
  .extracted-id.ok{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:var(--green);}
  .extracted-id.err{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red);}

  /* Connect error shown on connect screen */
  #connectError{
    display:none;
    background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);
    border-radius:10px;padding:14px 16px;margin-bottom:14px;
    color:var(--red);font-size:0.74rem;font-family:var(--fm);text-align:left;
    line-height:1.6;
  }

  .connect-btn{
    width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),var(--purple));
    border:none;border-radius:10px;color:#000;font-family:var(--fh);font-weight:800;
    font-size:0.88rem;cursor:pointer;letter-spacing:0.5px;transition:all 0.2s;
  }
  .connect-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,212,255,0.3);}
  .connect-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
  .demo-link{margin-top:14px;font-size:0.72rem;color:var(--muted);cursor:pointer;text-decoration:underline;}
  .demo-link:hover{color:var(--accent);}

  /* HEADER */
  header{
    position:relative;z-index:10;
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 28px;border-bottom:1px solid var(--border);
    background:rgba(8,12,20,0.97);backdrop-filter:blur(12px);
  }
  .logo{display:flex;align-items:center;gap:10px;}
  .logo-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--purple));display:grid;place-items:center;font-size:18px;}
  .logo h1{font-size:1.1rem;font-weight:800;}
  .logo span{font-size:0.65rem;color:var(--muted);font-family:var(--fm);display:block;}
  .header-right{display:flex;align-items:center;gap:10px;}
  .sheet-badge{display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);padding:5px 12px;border-radius:20px;font-size:0.65rem;font-family:var(--fm);color:var(--green);}
  .sheet-badge::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 2s infinite;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
  .refresh-btn{background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);color:var(--accent);padding:7px 14px;border-radius:8px;font-family:var(--fh);font-weight:700;font-size:0.72rem;cursor:pointer;transition:all 0.2s;}
  .refresh-btn:hover{background:rgba(0,212,255,0.2);}
  .disconnect-btn{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red);padding:7px 14px;border-radius:8px;font-size:0.72rem;cursor:pointer;font-family:var(--fh);font-weight:600;}

  /* MAIN */
  .main{position:relative;z-index:5;padding:22px 28px;display:flex;flex-direction:column;gap:20px;}

  /* ALERTS */
  .alerts-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:2px;}
  .alert-pill{flex-shrink:0;display:flex;align-items:center;gap:7px;padding:9px 14px;border-radius:10px;font-size:0.72rem;font-family:var(--fm);animation:slideIn 0.4s ease-out backwards;}
  .alert-pill.danger{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red);}
  .alert-pill.warn{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:var(--yellow);}
  .alert-pill.info{background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);color:var(--accent);}
  @keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}

  /* KPI */
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
  .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;position:relative;overflow:hidden;transition:transform 0.2s;}
  .kpi:hover{transform:translateY(-3px);}
  .kpi.hl{border-color:var(--accent);}
  .kpi.hl::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--purple));}
  .kpi-label{font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;}
  .kpi-val{font-size:1.9rem;font-weight:800;line-height:1;}
  .kpi-sub{font-size:0.68rem;color:var(--muted);margin-top:5px;font-family:var(--fm);}
  .kpi-icon{position:absolute;top:14px;right:14px;font-size:22px;opacity:0.2;}

  /* SECTION */
  .sec-title{font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);display:flex;align-items:center;gap:8px;margin-bottom:12px;}
  .sec-title::after{content:'';flex:1;height:1px;background:var(--border);}

  /* TABLE */
  .tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
  table{width:100%;border-collapse:collapse;font-size:0.73rem;}
  th{color:var(--muted);font-weight:600;text-align:left;padding:10px 14px;border-bottom:1px solid var(--border);font-size:0.62rem;text-transform:uppercase;letter-spacing:1px;background:rgba(0,212,255,0.03);}
  td{padding:11px 14px;border-bottom:1px solid rgba(30,45,66,0.5);}
  tr:last-child td{border:none;}
  tr:hover td{background:rgba(0,212,255,0.02);}
  .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:6px;font-size:0.63rem;font-family:var(--fm);font-weight:700;}
  .badge.active{background:rgba(16,185,129,0.15);color:var(--green);}
  .badge.warn{background:rgba(245,158,11,0.15);color:var(--yellow);}
  .badge.critical{background:rgba(239,68,68,0.15);color:var(--red);}
  .badge.expired{background:rgba(100,116,139,0.2);color:var(--muted);}
  .badge.plan{background:rgba(0,212,255,0.1);color:var(--accent);}
  .days-bar-wrap{width:90px;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:6px;}
  .days-bar{height:100%;border-radius:3px;transition:width 1s;}
  .proof-link{color:var(--accent);font-size:0.65rem;font-family:var(--fm);text-decoration:none;}
  .proof-link:hover{text-decoration:underline;}

  /* REMINDER GRID */
  .rem-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
  .rem-card{padding:14px;border-radius:12px;border:1px solid;position:relative;overflow:hidden;}
  .rem-card.expired{border-color:rgba(239,68,68,0.5);background:rgba(239,68,68,0.06);}
  .rem-card.critical{border-color:rgba(239,68,68,0.4);background:rgba(239,68,68,0.04);}
  .rem-card.warn{border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.04);}
  .rem-card.soon{border-color:rgba(0,212,255,0.3);background:rgba(0,212,255,0.03);}
  .rem-emoji{position:absolute;right:12px;top:10px;font-size:22px;opacity:0.25;}
  .rem-type{font-size:0.63rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:700;}
  .rem-name{font-size:0.82rem;font-weight:700;}
  .rem-detail{font-size:0.65rem;color:var(--muted);font-family:var(--fm);margin-top:2px;}
  .rem-tag{display:inline-flex;padding:3px 8px;border-radius:5px;font-size:0.63rem;font-family:var(--fm);margin-top:8px;}
  .expired .rem-type,.expired .rem-tag{color:var(--red);}
  .expired .rem-tag{background:rgba(239,68,68,0.15);}
  .critical .rem-type,.critical .rem-tag{color:var(--red);}
  .critical .rem-tag{background:rgba(239,68,68,0.12);}
  .warn .rem-type,.warn .rem-tag{color:var(--yellow);}
  .warn .rem-tag{background:rgba(245,158,11,0.12);}
  .soon .rem-type,.soon .rem-tag{color:var(--accent);}
  .soon .rem-tag{background:rgba(0,212,255,0.1);}

  /* EMPTY */
  .empty{text-align:center;padding:40px;color:var(--muted);font-size:0.8rem;}
  .loading{text-align:center;padding:40px;color:var(--accent);font-size:0.8rem;font-family:var(--fm);animation:blink 1s infinite;}

  /* ERROR */
  .error-box{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:16px;color:var(--red);font-size:0.78rem;font-family:var(--fm);}

  @media(max-width:1100px){.kpi-grid{grid-template-columns:repeat(2,1fr);}.rem-grid{grid-template-columns:1fr 1fr;}}
  @media(max-width:700px){.kpi-grid{grid-template-columns:1fr 1fr;}.rem-grid{grid-template-columns:1fr;}header{padding:12px 16px;}.main{padding:14px;}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê CONNECT SCREEN ‚ïê‚ïê‚ïê -->
<div id="connectScreen">
  <div class="connect-box">
    <div style="font-size:40px;margin-bottom:12px">üìä</div>
    <h2>Connect Your Google Sheet</h2>
    <p>Paste your Google Sheet link below. The dashboard will auto-extract the Sheet ID, fetch your study hall data, and calculate expiry dates & reminders automatically.</p>

    <div class="step-row">
      <div class="step">
        <div class="step-num">1</div>
        <div class="step-text">Open your Google Sheet ‚Üí Click <strong>Share</strong> ‚Üí Set to <strong>"Anyone with the link can view"</strong></div>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <div class="step-text">Copy the full URL from your browser ‚Äî looks like:<br><code>https://docs.google.com/spreadsheets/d/YOUR_ID/edit...</code></div>
      </div>
      <div class="step">
        <div class="step-num">3</div>
        <div class="step-text">Paste below. Sheet ID is extracted automatically. No API key needed for public sheets!</div>
      </div>
    </div>

    <div class="input-group">
      <label>Google Sheet URL</label>
      <input type="text" id="sheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/..." oninput="extractId(this.value)" />
    </div>
    <div class="extracted-id" id="extractedId"></div>

    <div class="input-group">
      <label>Sheet / Tab Name <span style="color:var(--muted);text-transform:none;letter-spacing:0">(leave blank for first sheet)</span></label>
      <input type="text" id="sheetNameInput" placeholder="Sheet1" />
    </div>

    <!-- Error shown HERE on connect screen if fetch fails -->
    <div id="connectError"></div>

    <button class="connect-btn" id="connectBtn" onclick="connectSheet()" disabled>
      üîó Connect & Load Data
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
<div id="dashboard" style="display:none">

  <header>
    <div class="logo">
      <div class="logo-icon">üìö</div>
      <div>
        <h1>StudyHalls Dashboard</h1>
        <span id="sheetLabel">Loading...</span>
      </div>
    </div>
    <div class="header-right">
      <div class="sheet-badge" id="syncBadge">SHEET CONNECTED</div>
      <button class="refresh-btn" onclick="refreshData()">‚ü≥ Refresh</button>
      <button class="disconnect-btn" onclick="disconnect()">‚úï Disconnect</button>
    </div>
  </header>

  <div class="main" id="mainContent">
    <div class="loading">‚è≥ Loading data from Google Sheets...</div>
  </div>

</div>

<script>
// ‚ïê‚ïê‚ïê GLOBALS ‚ïê‚ïê‚ïê
let sheetId = '';
let sheetName = 'Sheet1';
let allStudents = [];

// ‚ïê‚ïê‚ïê PLAN LOGIC ‚ïê‚ïê‚ïê
const PLANS = [
  { amount: 950,  days: 15,  label: '15 Days' },
  { amount: 1700, days: 30,  label: '1 Month' },
  { amount: 3400, days: 60,  label: '2 Months' },
  { amount: 4800, days: 90,  label: '3 Months' },
];

function getPlan(amount) {
  const amt = parseInt(amount);
  let closest = PLANS.reduce((prev, curr) =>
    Math.abs(curr.amount - amt) < Math.abs(prev.amount - amt) ? curr : prev
  );
  return closest;
}

function getExpiryDate(joinDate, planDays) {
  const d = new Date(joinDate);
  d.setDate(d.getDate() + planDays);
  return d;
}

function getDaysLeft(expiryDate) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const exp = new Date(expiryDate);
  exp.setHours(0,0,0,0);
  return Math.ceil((exp - today) / (1000*60*60*24));
}

function getStatus(daysLeft) {
  if (daysLeft < 0)  return { label: 'EXPIRED',  cls: 'expired',  icon: 'üíÄ' };
  if (daysLeft <= 3) return { label: 'CRITICAL', cls: 'critical', icon: 'üö®' };
  if (daysLeft <= 7) return { label: 'DUE SOON', cls: 'warn',     icon: '‚ö†Ô∏è' };
  return               { label: 'ACTIVE',   cls: 'active',   icon: '‚úÖ' };
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d);
  return dt.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
}

function fmtINR(n) {
  const num = parseInt(n) || 0;
  return '‚Çπ' + num.toLocaleString('en-IN');
}

// ‚ïê‚ïê‚ïê EXTRACT SHEET ID FROM URL ‚ïê‚ïê‚ïê
function extractId(url) {
  const box = document.getElementById('extractedId');
  const btn = document.getElementById('connectBtn');
  // Clear previous connect error whenever user edits URL
  showConnectError('');

  const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]{20,})/);
  if (match) {
    sheetId = match[1];
    box.style.display = 'block';
    box.className = 'extracted-id ok';
    box.textContent = '‚úì Sheet ID extracted: ' + sheetId.substring(0,24) + '...';
    btn.disabled = false;
  } else if (url.length > 10) {
    sheetId = '';
    box.style.display = 'block';
    box.className = 'extracted-id err';
    box.textContent = '‚úó Could not extract Sheet ID. Make sure you copied the full URL.';
    btn.disabled = true;
  } else {
    sheetId = '';
    box.style.display = 'none';
    btn.disabled = true;
  }
}

// ‚ïê‚ïê‚ïê SHOW/HIDE CONNECT ERROR ‚ïê‚ïê‚ïê
function showConnectError(msg) {
  const el = document.getElementById('connectError');
  if (!msg) {
    el.style.display = 'none';
    el.innerHTML = '';
    return;
  }
  el.style.display = 'block';
  el.innerHTML = msg;
}

// ‚ïê‚ïê‚ïê CONNECT ‚Äî stays on connect screen until fetch succeeds ‚ïê‚ïê‚ïê
async function connectSheet() {
  if (!sheetId) return;

  const btn = document.getElementById('connectBtn');
  const nameInput = document.getElementById('sheetNameInput').value.trim();
  sheetName = nameInput || 'Sheet1';

  // Show loading state on button, keep connect screen visible
  btn.disabled = true;
  btn.textContent = '‚è≥ Connecting...';
  showConnectError('');

  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const proxiedUrl = `https://corsproxy.io/?url=${encodeURIComponent(csvUrl)}`;

  try {
    const res = await fetch(proxiedUrl);
    if (!res.ok) throw new Error('HTTP ' + res.status + ' ‚Äî Could not reach the sheet.');
    const text = await res.text();

    // Check if Google returned an error page instead of CSV
    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
      throw new Error('Google returned an error. The sheet may not be publicly shared.');
    }

    const rows = parseCSV(text);
    if (rows.length < 2) throw new Error('Sheet appears empty or has no data rows.');

    // ‚úÖ Success ‚Äî now show dashboard
    const students = buildStudents(rows);
    allStudents = students;

    document.getElementById('connectScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('sheetLabel').textContent = 'Sheet ID: ' + sheetId.substring(0,20) + '...';

    renderDashboard();

  } catch(e) {
    // ‚ùå Stay on connect screen, show error
    showConnectError(
      `‚ùå <strong>Could not connect:</strong> ${e.message}<br><br>
      <strong>Checklist:</strong><br>
      ‚Ä¢ Sheet is shared as "Anyone with the link can view"<br>
      ‚Ä¢ Sheet tab name matches (default: Sheet1)<br>
      ‚Ä¢ The URL is a valid Google Sheets link`
    );
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîó Connect & Load Data';
  }
}

// ‚ïê‚ïê‚ïê FETCH FROM GOOGLE SHEETS (refresh, already on dashboard) ‚ïê‚ïê‚ïê
async function fetchAndRender() {
  const mc = document.getElementById('mainContent');
  mc.innerHTML = '<div class="loading">‚è≥ Fetching data from Google Sheets...</div>';

  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const proxiedUrl = `https://corsproxy.io/?url=${encodeURIComponent(csvUrl)}`;

  try {
    const res = await fetch(proxiedUrl);
    if (!res.ok) throw new Error('Could not fetch sheet. HTTP ' + res.status);
    const text = await res.text();
    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
      throw new Error('Google returned an error page. Check that sharing is still set to "Anyone with the link can view".');
    }
    const rows = parseCSV(text);
    if (rows.length < 2) throw new Error('Sheet appears empty or column names do not match expected format.');
    allStudents = buildStudents(rows);
    renderDashboard();
  } catch(e) {
    mc.innerHTML = `<div class="error-box">‚ùå ${e.message}<br><br>
      <strong>Checklist:</strong><br>
      ‚Ä¢ Sheet is shared as "Anyone with the link can view"<br>
      ‚Ä¢ Sheet tab name matches (default: Sheet1)<br>
      ‚Ä¢ Columns: Name | Join Date | payment amount | Payment Date | Room | Seat No | purpose | Phone Number | adrees proof photo link | __PowerAppsId__
    </div>`;
  }
}

// ‚ïê‚ïê‚ïê PARSE CSV ‚ïê‚ïê‚ïê
function parseCSV(text) {
  const lines = text.trim().split('\n');
  return lines.map(line => {
    const cols = [];
    let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') { inQ = !inQ; }
      else if (c === ',' && !inQ) { cols.push(cur.trim()); cur = ''; }
      else cur += c;
    }
    cols.push(cur.trim());
    return cols;
  });
}

// ‚ïê‚ïê‚ïê PROCESS ROWS ‚Üí STUDENT OBJECTS ‚ïê‚ïê‚ïê
function buildStudents(rows) {
  const headers = rows[0].map(h => h.replace(/^"|"$/g,'').toLowerCase().trim());

  const col = (name) => {
    const aliases = {
      'name': ['name'],
      'joindate': ['join date','joindate','join_date','enrollment date'],
      'amount': ['payment amount','amount','fee','payment_amount'],
      'paydate': ['payment date','payment_date','paid date'],
      'room': ['room','hall','room no'],
      'seat': ['seat no','seat','seat number','seat_no'],
      'purpose': ['purpose','type'],
      'phone': ['phone number','phone','mobile','contact'],
      'proof': ['adrees proof photo link','address proof','proof link','proof_link','address proof photo link'],
      'powerid': ['__powerappsid__','powerappsid','id'],
    };
    const list = aliases[name] || [name];
    for (const alias of list) {
      const idx = headers.findIndex(h => h.includes(alias));
      if (idx >= 0) return idx;
    }
    return -1;
  };

  const C = {
    name:    col('name'),
    join:    col('joindate'),
    amount:  col('amount'),
    paydate: col('paydate'),
    room:    col('room'),
    seat:    col('seat'),
    purpose: col('purpose'),
    phone:   col('phone'),
    proof:   col('proof'),
    id:      col('powerid'),
  };

  const students = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r[C.name] || r[C.name] === '') continue;
    const clean = (idx) => idx >= 0 ? (r[idx] || '').replace(/^"|"$/g,'').trim() : '';
    const name    = clean(C.name);
    const join    = clean(C.join);
    const amount  = clean(C.amount).replace(/[‚Çπ,]/g,'');
    const paydate = clean(C.paydate);
    const room    = clean(C.room);
    const seat    = clean(C.seat);
    const purpose = clean(C.purpose);
    const phone   = clean(C.phone);
    const proof   = clean(C.proof);

    const plan    = getPlan(amount);
    const expiry  = getExpiryDate(join, plan.days);
    const daysLeft = getDaysLeft(expiry);
    const status  = getStatus(daysLeft);

    students.push({ name, join, amount, paydate, room, seat, purpose, phone, proof, plan, expiry, daysLeft, status });
  }
  return students;
}

// ‚ïê‚ïê‚ïê RENDER DASHBOARD ‚ïê‚ïê‚ïê
function renderDashboard() {
  const mc = document.getElementById('mainContent');

  const total = allStudents.reduce((s,st) => s + (parseInt(st.amount)||0), 0);
  const active = allStudents.filter(s => s.status.cls === 'active').length;
  const expired = allStudents.filter(s => s.status.cls === 'expired').length;
  const critical = allStudents.filter(s => s.status.cls === 'critical' || s.status.cls === 'warn').length;
  const reminders = allStudents.filter(s => s.daysLeft <= 7);

  const alertsHtml = buildAlerts(reminders);
  const kpiHtml = buildKPIs(total, allStudents.length, active, expired, critical);
  const tableHtml = buildTable();
  const reminderHtml = buildReminders(reminders);

  mc.innerHTML = alertsHtml + kpiHtml +
    `<div class="sec-title">üìã Student Records</div>` + tableHtml +
    `<div class="sec-title">üîî Expiry Reminder Alerts</div>` + reminderHtml;
}

function buildAlerts(reminders) {
  if (!reminders.length && allStudents.length > 0) {
    return `<div class="alerts-scroll"><div class="alert-pill info">‚úÖ All students are active ‚Äî no reminders needed</div></div>`;
  }
  let html = '<div class="alerts-scroll">';
  reminders.sort((a,b) => a.daysLeft - b.daysLeft).slice(0,8).forEach((s,i) => {
    const cls = s.daysLeft < 0 ? 'danger' : s.daysLeft <= 3 ? 'danger' : 'warn';
    const msg = s.daysLeft < 0
      ? `üî¥ EXPIRED ${Math.abs(s.daysLeft)} days ago`
      : s.daysLeft === 0 ? `üî¥ EXPIRES TODAY`
      : `‚ö†Ô∏è EXPIRES IN ${s.daysLeft} DAY${s.daysLeft>1?'S':''}`;
    html += `<div class="alert-pill ${cls}" style="animation-delay:${i*0.07}s">${msg} ¬∑ ${s.name} ¬∑ ${s.room} Seat ${s.seat} ¬∑ ${s.plan.label} Plan ¬∑ ${fmtINR(s.amount)}</div>`;
  });
  html += '</div>';
  return html;
}

function buildKPIs(total, count, active, expired, critical) {
  const highRoom = allStudents.reduce((acc, s) => {
    acc[s.room] = (acc[s.room]||0) + (parseInt(s.amount)||0);
    return acc;
  }, {});
  const topRoom = Object.entries(highRoom).sort((a,b)=>b[1]-a[1])[0];

  return `<div class="kpi-grid">
    <div class="kpi hl">
      <div class="kpi-icon">üí∞</div>
      <div class="kpi-label">Total Collection</div>
      <div class="kpi-val">${fmtINR(total)}</div>
      <div class="kpi-sub">${count} students enrolled</div>
    </div>
    <div class="kpi">
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-label">Active Students</div>
      <div class="kpi-val" style="color:var(--green)">${active}</div>
      <div class="kpi-sub">out of ${count} total</div>
    </div>
    <div class="kpi">
      <div class="kpi-icon">üîî</div>
      <div class="kpi-label">Expiry Alerts</div>
      <div class="kpi-val" style="color:var(--yellow)">${critical}</div>
      <div class="kpi-sub">due within 7 days</div>
    </div>
    <div class="kpi">
      <div class="kpi-icon">üíÄ</div>
      <div class="kpi-label">Expired / Top Room</div>
      <div class="kpi-val" style="color:var(--red);font-size:1.3rem">${expired} expired${topRoom ? ` ¬∑ ${topRoom[0]}` : ''}</div>
      <div class="kpi-sub">${topRoom ? `${topRoom[0]}: ${fmtINR(topRoom[1])}` : '‚Äî'}</div>
    </div>
  </div>`;
}

function buildTable() {
  if (!allStudents.length) return '<div class="empty">No student data found in sheet.</div>';
  let rows = '';
  allStudents.forEach(s => {
    const pct = Math.max(0, Math.min(100, Math.round(s.daysLeft / s.plan.days * 100)));
    const barColor = s.status.cls === 'active' ? 'var(--green)' : s.status.cls === 'expired' ? 'var(--muted)' : s.status.cls === 'critical' ? 'var(--red)' : 'var(--yellow)';
    const proofCell = s.proof
      ? `<a class="proof-link" href="${s.proof}" target="_blank">üîó View</a>`
      : '<span style="color:var(--muted);font-size:0.65rem">‚Äî</span>';
    rows += `<tr>
      <td><strong>${s.name}</strong><br><span style="color:var(--muted);font-size:0.63rem;font-family:var(--fm)">${s.phone}</span></td>
      <td>${s.room}<br><span style="color:var(--muted);font-size:0.63rem">Seat ${s.seat}</span></td>
      <td><span class="badge plan">${s.plan.label}</span><br><span style="color:var(--muted);font-size:0.63rem;font-family:var(--fm)">${fmtINR(s.amount)}</span></td>
      <td style="font-family:var(--fm);font-size:0.7rem">${fmtDate(s.join)}</td>
      <td style="font-family:var(--fm);font-size:0.7rem">${fmtDate(s.expiry)}</td>
      <td>
        <span class="badge ${s.status.cls}">${s.status.icon} ${s.status.label}</span>
        <div style="margin-top:4px;display:flex;align-items:center;gap:4px">
          <span style="font-size:0.6rem;font-family:var(--fm);color:var(--muted)">${s.daysLeft < 0 ? Math.abs(s.daysLeft)+'d ago' : s.daysLeft+'d left'}</span>
          <div class="days-bar-wrap"><div class="days-bar" style="width:${pct}%;background:${barColor}"></div></div>
        </div>
      </td>
      <td>${proofCell}</td>
    </tr>`;
  });

  return `<div class="tbl-wrap"><table>
    <thead><tr>
      <th>Student</th><th>Room / Seat</th><th>Plan</th>
      <th>Join Date</th><th>Expiry Date</th><th>Status</th><th>Proof</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function buildReminders(reminders) {
  if (!reminders.length) return '<div class="empty" style="background:var(--card);border:1px solid var(--border);border-radius:14px">üéâ No reminders ‚Äî all students are active!</div>';
  const sorted = [...reminders].sort((a,b) => a.daysLeft - b.daysLeft);
  let html = '<div class="rem-grid">';
  sorted.forEach(s => {
    const cls = s.daysLeft < 0 ? 'expired' : s.daysLeft <= 3 ? 'critical' : s.daysLeft <= 7 ? 'warn' : 'soon';
    const emoji = s.daysLeft < 0 ? 'üíÄ' : s.daysLeft <= 3 ? 'üö®' : '‚ö†Ô∏è';
    const tagText = s.daysLeft < 0 ? `${Math.abs(s.daysLeft)} DAYS OVERDUE` : s.daysLeft === 0 ? 'EXPIRES TODAY' : `${s.daysLeft} DAYS LEFT`;
    html += `<div class="rem-card ${cls}">
      <div class="rem-emoji">${emoji}</div>
      <div class="rem-type">${s.status.label}</div>
      <div class="rem-name">${s.name}</div>
      <div class="rem-detail">${s.room} ¬∑ Seat ${s.seat} ¬∑ ${s.plan.label} Plan ¬∑ ${fmtINR(s.amount)}</div>
      <div class="rem-detail" style="margin-top:2px">üìû ${s.phone || '‚Äî'} ¬∑ Joined ${fmtDate(s.join)}</div>
      <div class="rem-tag">${tagText}</div>
    </div>`;
  });
  html += '</div>';
  return html;
}

function refreshData() {
  if (sheetId) fetchAndRender();
}

function disconnect() {
  sheetId = ''; allStudents = [];
  document.getElementById('sheetUrlInput').value = '';
  document.getElementById('extractedId').style.display = 'none';
  document.getElementById('connectBtn').disabled = true;
  showConnectError('');
  // Reset sync badge style
  const badge = document.getElementById('syncBadge');
  badge.textContent = 'SHEET CONNECTED';
  badge.style.color = '';
  badge.style.borderColor = '';
  badge.style.background = '';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('connectScreen').style.display = 'flex';
}
</script>
</body>
</html>
